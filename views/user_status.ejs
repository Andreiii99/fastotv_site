<!doctype html>
<html>
<head>
  <title><%- site.title %></title>
  <meta charset="utf-8">
  <meta name="description" content="<%- site.large_description %>"/>
  <meta name="keywords" content="<%- site.keywords %>" />
  <meta name="copyright" content="<%- site.domain %>" />
  <meta name="webmoney.attestation.label" CONTENT="webmoney attestation label#7DF987B9-C387-4DD0-BF5B-F23AB453166D" />

  <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.0.2/css/bootstrap.min.css">
  <link rel="stylesheet" href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.min.css">
  <style>
    body         { padding-top:80px; }
  </style>
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', '<%- site.google_analitics_token %>', 'auto');
    ga('send', 'pageview');
  </script>
  <script src="scripts/script.js" type="text/javascript"></script>
  <script src="<%= site.domain %>:<%= back_end.socketio_port %>/socket.io/socket.io.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
  <script>
  var socket = io.connect('<%= site.domain %>:<%= back_end.socketio_port %>');

  function handle_on_connection_changed(host, is_connected) {
    var id_control = '#status_img' + host;
    if (is_connected) {
      $(id_control).attr("src", SERVER_STATUS_IMG.ONLINE);
    } else {
      $(id_control).attr("src", SERVER_STATUS_IMG.OFFLINE);
    }
  }

  function handle_state_changed(stateObj) {                
    handle_on_connection_changed(stateObj.host, stateObj.status === CONNECTED_STATUS.CONNECTED);
  }

  //on connetion, updates connection state and sends subscribe request
  socket.on('connect', function(data){
  socket.emit('subscribe_redis', {channel:'<%= back_end.pub_sub_channel_client_state %>'});
  });

  //when reconnection is attempted, updates status 
  socket.on('reconnecting', function(data){
  });

  //on new message adds a new message to display
  socket.on('message', function (data) {
    var msg = data.text;
    if (data.channel === '<%= back_end.pub_sub_channel_client_state %>') {
      var stateObj = parse_state_msg(msg);
      if (stateObj == undefined) {
        return;
      }

      handle_state_changed(stateObj);
    }
  });

  </script>
</head>
<body>
  <div class="container">
    <% if (users.length > 0) { %>
      <div class="well">                
      <h2>Registered users:</h2>
        <table class="table">
          <thead>
          <tr>
            <th>#</th>
            <th>Name</th>
            <th>Date created</th>
          </tr>
          </thead>
          <tbody>
          <% for (var i = 0; i < users.length; i++) { %>
          <tr>
            <td><%= i + 1 %></td>
            <td><img id="status_img<%= users[i].id %>" src="images/offline.png"/> <%= users[i].name %></td>
            <td><%= users[i].created_date %></td>
          </tr>    
          <% } %>
          </tbody>              
        </table>
      </div>
    <% } %> 
  </div>
</body>
</html>
