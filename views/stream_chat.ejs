<!doctype html>
<html>
<head>
  <%- include('head/main'); %>
  <script src="scripts/script.js" type="text/javascript"></script>
  <script src="<%= site.domain %>:<%= back_end.socketio_port %>/socket.io/socket.io.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
  <script>
    var socket = io.connect('<%= site.domain %>:<%= back_end.socketio_port %>');

    //on connetion, updates connection state and sends subscribe request
    socket.on('connect', function (data) {
      socket.emit('join_chat', {channel: '<%= channel_id %>', user: '<%- login %>'});
    });

    //on connetion, updates connection state and sends subscribe request
    socket.on('disconnect', function () {
      console.log('disconnected');
    });
    
    //when reconnection is attempted, updates status
    socket.on('reconnecting', function (data) {
      socket.emit('leave_chat', {channel: '<%= channel_id %>', user: '<%- login %>'});
      socket.emit('join_chat', {channel: '<%= channel_id %>', user: '<%- login %>'});
    });

    //on new message adds a new message to display
    socket.on('post_to_chat', function (data) {
      log.message(data);
      if (data.channel === '<%= channel_id %>') {
      }
    });

    // new message is send in the input box
    $('#channel form').submit(function (event) {
      event.preventDefault();
      var input = $(this).find(':input');
      var msg = input.val();
      socket.emit('post_to_chat', {channel: '<%= channel_id %>', user: '<%- login %>', msg: msg});
      input.val('');
    });

  </script>
</head>
<body>
<header role="banner" class="transparent light">
  <%- include('header/main') %>
</header>
<div class="container">
  <div id="channel" class="bordered" style="display: none;">
    <div id="descr" class="bordered">
      <strong>Note:</strong> your messages make a round-trip up and down the stack (including Redis)
      before being displayed here.<br/>
      <strong>Tip:</strong> open up another browser window
      to see how quickly your messages are distributed.
    </div>
    <div id="msgs">
      <ul>
        <li class="message" style="display: none">
          <span class="user"></span><span class="message"></span>
          <span class="time"></span>
        </li>
        <li class="control" style="display: none">
          <span class="user"></span>&nbsp;<span class="message"></span>
          <span class="time"></span>
        </li>
      </ul>
    </div>
    <div id="input">
      <form><input type="text" id="message"/></form>
    </div>
  </div>
</div>
<footer class="footer">
  <%- include('footer/main') %>
</footer>
</body>
</html>
