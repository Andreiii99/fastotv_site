<!doctype html>
<html>
<head>
  <%- include('head/main') %>
  <script src="scripts/script.js" type="text/javascript"></script>
  <script src="<%= site.domain%>:<%= back_end.socketio_port %>/socket.io/socket.io.js"></script>
  
  <script>
    const GB = (1024*1024*1024)
              
    //socket io client
    //var io = require('socket.io');
    var socket = io.connect('<%= site.domain %>:<%= back_end.socketio_port %>');
    
    function handle_onconnection_changed(is_connected) {
        if (is_connected) {
            $('#status_label').html(SERVER_STATUS.ONLINE);
            $('#status_img').attr("src", SERVER_STATUS_IMG.ONLINE);
            $('#info_button').prop('disabled', false);
        } else {
            $('#status_label').html(SERVER_STATUS.OFFLINE);
            $('#status_img').attr("src", SERVER_STATUS_IMG.OFFLINE);
            $('#info_button').prop('disabled', true);
            
            $('#os_label').html(SERVER_OS_DEFAULT_LABEL);
            $('#cpu_label').html(SERVER_CPU_DEFAULT_LABEL);
            $('#ram_label').html(SERVER_RAM_DEFAULT_LABEL);
        }
    }
    
    function handle_state_changed(stateObj) {
        if(stateObj.host !== '<%- domain_name %>'){
            return;
        }
        
        handle_onconnection_changed(stateObj.status === CONNECTED_STATUS.CONNECTED);
    }
    
    function handle_command_received(msgObj) {
      if ('<%- user_id %>' !== msgObj.id) {
          return;
      }
      
      var is_ok = is_succsess_command(msgObj);
      
      if (is_ping_command(msgObj)) {
          handle_onconnection_changed(is_ok);
      } else if(is_info_command(msgObj)) {
          if (is_ok) {
              var system_info = JSON.parse(msgObj.args);
              $('#os_label').html(system_info.os);
              $('#cpu_label').html(system_info.cpu);
              var ram_total_gb = system_info.ram_total/GB;
              var ram_total_fr = system_info.ram_free/GB;
              $('#ram_label').html(ram_total_gb.toFixed(2) + " GB (" + ram_total_fr.toFixed(2) + " GB free)");
          } else {
              $('#os_label').html(SERVER_OS_DEFAULT_LABEL);
              $('#cpu_label').html(SERVER_CPU_DEFAULT_LABEL);
              $('#ram_label').html(SERVER_RAM_DEFAULT_LABEL);
          }
      }
    }
    
    //on connetion, updates connection state and sends subscribe request
    socket.on('connect', function(data){
        socket.emit('subscribe_redis', {channel:'<%= back_end.pub_sub_channel_out %>'});
        socket.emit('subscribe_redis', {channel:'<%= back_end.pub_sub_channel_client_state %>'});
    });

    //when reconnection is attempted, updates status 
    socket.on('reconnecting', function(data){
    });

    //on new message adds a new message to display
    socket.on('message', function (data) {
        var msg = data.text;
        
        if (data.channel === '<%= back_end.pub_sub_channel_out %>') {
            var msgObj = parse_command_out(msg);
            if(msgObj == undefined){
                return;
            }
            
            handle_command_received(msgObj);
        } else if(data.channel === '<%= back_end.pub_sub_channel_client_state %>') {
            var stateObj = parse_state_msg(msg);
            if(stateObj == undefined){
                return;
            }
            
            handle_state_changed(stateObj);
        }
    });
    
    function init() {
        ping_device('<%- user_id %>', '<%- login %>', socket);
        $('#status_label').html(SERVER_STATUS.OFFLINE);
        $('#status_img').attr("src", SERVER_STATUS_IMG.OFFLINE);
        $('#os_label').html(SERVER_OS_DEFAULT_LABEL);
        $('#cpu_label').html(SERVER_CPU_DEFAULT_LABEL);
        $('#ram_label').html(SERVER_RAM_DEFAULT_LABEL);
    }
  </script>
</head>
<body onload = "init()">
  <div class="row">
    <div class="container">
      <legend id="server_name_label"><%- login %></legend>
      <div class="col-sm-4">
        <div class="well">                        
            Status: <img id="status_img" src="images/offline.png"/> <label id="status_label"></label><br>
            Os: <label id="os_label"></label><br>
            Processor: <label id="cpu_label"></label><br>
            Installed memory(RAM): <label id="ram_label"></label>
        </div>
        <button id="info_button" disabled onclick="device_info('<%- user_id %>', '<%- login %>', socket)">Info</button>
      </div>
    </div>
  </div>
</body>
</html>
